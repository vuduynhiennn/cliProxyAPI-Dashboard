<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLIProxy Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bg: '#0B0E1F', // Deep Vision Blue-Black
            card: 'rgba(22, 27, 34, 0.6)',
            accent: '#0075FF',
            'accent-hover': '#0061D5',
            success: '#01B574', // Vision Green
            danger: '#E53E3E',
            warning: '#FF9F43',
            info: '#17c1e8',
            text: '#FFFFFF',
            muted: '#A0AEC0',
            border: 'rgba(255,255,255,0.08)',
            'glass-border': 'rgba(255, 255, 255, 0.05)',
          },
          fontFamily: {
            sans: ['"Plus Jakarta Display"', 'Helvetica', 'Arial', 'sans-serif'],
            mono: ['"JetBrains Mono"', 'monospace'],
          },
          backdropBlur: {
            xs: '2px',
            xl: '24px',
          },
          animation: {
            'wiggle': 'wiggle 1s ease-in-out infinite',
            'float': 'float 6s ease-in-out infinite',
            'glow-pulse': 'glow-pulse 3s infinite',
            'fade-in': 'fadeIn 0.5s ease-out forwards',
          },
          keyframes: {
            wiggle: {
              '0%, 100%': { transform: 'rotate(-3deg)' },
              '50%': { transform: 'rotate(3deg)' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            'glow-pulse': {
              '0%, 100%': { boxShadow: '0 0 5px rgba(0, 117, 255, 0.2)' },
              '50%': { boxShadow: '0 0 20px rgba(0, 117, 255, 0.6)' },
            },
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          },
          boxShadow: {
            'glow': '0 0 20px rgba(0, 117, 255, 0.5)',
            'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Display:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Plus Jakarta Display', sans-serif;
      background-color: #0F1214;
      background-image: url('https://demos.creative-tim.com/vision-ui-dashboard-react/static/media/body-background.9ea97aa2.png');
      /* Vision UI Background */
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      color: #FFFFFF;
      overflow: hidden;
      /* Main scroll handled by content div */
    }

    /* Glassmorphism Utilities - Refined */
    .glass {
      background: linear-gradient(127.09deg, rgba(6, 11, 40, 0.94) 19.41%, rgba(10, 14, 35, 0.49) 76.65%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      /* Subtle default border */
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      /* Bouncy transition */
    }

    .glass:hover {
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.15) inset;
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px) scale(1.002);
    }

    .glass-no-hover {
      background: linear-gradient(127.09deg, rgba(6, 11, 40, 0.94) 19.41%, rgba(10, 14, 35, 0.49) 76.65%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .glass-input {
      background: rgba(15, 21, 53, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .glass-input:focus {
      border-color: #0075FF;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 117, 255, 0.25), 0 0 20px rgba(0, 117, 255, 0.15);
      /* Glow spread */
      background: rgba(15, 21, 53, 0.7);
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 15px;
      transition: all 0.3s ease;
      color: #A0AEC0;
      font-weight: 500;
      font-size: 0.875rem;
      position: relative;
      overflow: hidden;
    }

    .sidebar-link:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #FFFFFF;
      transform: translateX(4px);
    }

    /* Active Link Glow */
    .sidebar-link.active {
      background: #1A1F37;
      color: #FFFFFF;
      box-shadow: 0 20px 27px 0 rgb(0 0 0 / 5%), inset 0 0 0 1px rgba(0, 117, 255, 0.2);
      border: 1px solid rgba(0, 117, 255, 0.2);
    }

    .sidebar-link.active::after {
      content: '';
      position: absolute;
      width: 4px;
      height: 50%;
      left: 0;
      top: 25%;
      background: #0075FF;
      border-radius: 0 4px 4px 0;
      box-shadow: 0 0 10px #0075FF;
    }

    .sidebar-icon-container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border-radius: 12px;
      background: #1A1F37;
      margin-right: 12px;
      color: #0075FF;
      transition: all 0.3s;
    }

    .sidebar-link:hover .sidebar-icon-container {
      transform: scale(1.1);
      color: white;
    }

    .sidebar-link.active .sidebar-icon-container {
      background: linear-gradient(135deg, #0075FF 0%, #00C6FF 100%);
      color: #FFFFFF;
      box-shadow: 0 4px 15px rgba(0, 117, 255, 0.5);
      /* Stronger neon glow */
    }

    /* ... omitted nav-header ... */

    .btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.15);
      box-shadow: 0 7px 14px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .toggle-checkbox:checked {
      right: 0;
      border-color: #0075FF;
    }

    .toggle-checkbox:checked+.toggle-label {
      background-color: #0075FF;
    }

    .toggle-checkbox {
      right: 0;
      z-index: 10;
      width: 1.25rem;
      height: 1.25rem;
      cursor: pointer;
      opacity: 0;
      position: absolute;
    }

    .toggle-label {
      width: 2.5rem;
      height: 1.5rem;
      background-color: #374151;
      border-radius: 9999px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s ease-in;
    }

    /* New UI Switch */
    .ui-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      cursor: pointer;
    }

    .ui-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .ui-switch-track {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.1);
      transition: .3s;
      border-radius: 34px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ui-switch-thumb {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked+.ui-switch-track {
      background-color: #0075FF;
      border-color: #0075FF;
    }

    input:checked+.ui-switch-track+.ui-switch-thumb {
      transform: translateX(20px);
    }

    /* New toggle switch for header */
    input:checked~.dot {
      transform: translateX(100%);
      background-color: #0075FF;
    }

    #log-terminal {
      background: #0F1214;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .log-line-info {
      color: #A0B0C0;
    }

    .log-line-warn {
      color: #FF9800;
    }

    .log-line-error {
      color: #F44336;
    }

    .log-line-debug {
      color: #718096;
    }
  </style>
</head>

<body class="flex flex-row h-screen overflow-hidden">

  <!-- Mobile Backdrop -->
  <div id="sidebar-backdrop" onclick="toggleMobileMenu()"
    class="fixed inset-0 bg-black/50 z-40 hidden md:hidden transition-opacity backdrop-blur-sm"></div>

  <!-- Sidebar -->
  <aside id="sidebar"
    class="fixed inset-y-0 left-0 z-50 w-64 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out bg-[#0F1214] border-r border-white/5 flex flex-col h-full shadow-2xl md:shadow-none">
    <div class="p-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-accent/20 flex items-center justify-center text-accent shadow-glow">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
        </div>
        <div>
          <h1 class="font-bold text-lg tracking-tight">CLIProxy</h1>
          <p class="text-[10px] text-muted uppercase tracking-wider">Manager</p>
        </div>
      </div>
      <!-- Close Button (Mobile Only) -->
      <button onclick="toggleMobileMenu()" class="md:hidden text-muted hover:text-white">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent mb-6"></div>

    <div class="flex-1 overflow-y-auto">
      <button onclick="switchTab('overview')" id="tab-btn-overview" class="sidebar-link active w-full text-left group">
        <span class="sidebar-icon-container group-hover:bg-accent group-hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </span>
        Overview
      </button>
      <button onclick="switchTab('config')" id="tab-btn-config" class="sidebar-link w-full text-left group">
        <span class="sidebar-icon-container group-hover:bg-accent group-hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
            </path>
          </svg>
        </span>
        Configuration
      </button>
      <button onclick="switchTab('logs')" id="tab-btn-logs" class="sidebar-link w-full text-left group">
        <span class="sidebar-icon-container group-hover:bg-accent group-hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 17 10 11 4 5"></polyline>
            <line x1="12" y1="19" x2="20" y2="19"></line>
          </svg>
        </span>
        Logs
      </button>
      <button onclick="switchTab('activity')" id="tab-btn-activity" class="sidebar-link w-full text-left group">
        <span class="sidebar-icon-container group-hover:bg-accent group-hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
          </svg>
        </span>
        Activity
      </button>
      <button onclick="switchTab('advanced-keys')" id="tab-btn-advanced-keys"
        class="sidebar-link w-full text-left group">
        <span class="sidebar-icon-container group-hover:bg-accent group-hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </span>
        API Keys
      </button>
      <button onclick="switchTab('playground')" id="tab-btn-playground" class="sidebar-link w-full text-left group">
        <span class="sidebar-icon-container group-hover:bg-accent group-hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
            </path>
          </svg>
        </span>
        Playground
      </button>

      <div
        class="mt-8 mx-2 p-4 rounded-2xl glass border border-white/10 relative overflow-hidden hidden md:block group">
        <div class="relative z-10">
          <div
            class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center mb-3 group-hover:bg-white/20 transition-colors">
            <svg class="text-white" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
          </div>
          <div class="text-white text-sm font-bold mb-1">Status</div>
          <div class="text-white/80 text-xs mb-3">System: Online</div>
          <div class="text-xs font-mono bg-black/20 rounded px-2 py-1 text-white/90" id="header-host-port">
            0.0.0.0:8317
          </div>
        </div>
        <!-- decorative circles -->
        <div
          class="absolute -top-4 -right-4 w-20 h-20 bg-accent/20 rounded-full blur-xl group-hover:bg-accent/30 transition">
        </div>
        <div class="absolute bottom-0 right-0 w-16 h-16 bg-blue-500/10 rounded-full blur-md"></div>
      </div>

      <!-- Credits & Support -->
      <div class="mt-4 mx-2 text-center">
        <button onclick="openDonationModal()"
          class="w-full btn bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-500/30 text-yellow-200 text-xs font-bold py-2 rounded-lg mb-3 hover:bg-yellow-500/30 transition hover:shadow-glow hover:-translate-y-0.5">
          <span class="inline-block animate-bounce mr-1">‚òï</span> Buy Me a Coffee
        </button>
        <div class="text-[10px] text-muted">
          Credits: <a href="https://www.facebook.com/lehuyducanh/" target="_blank"
            class="text-accent hover:text-white transition underline">Brian Le</a>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 w-full md:ml-64 flex flex-col h-screen bg-transparent relative z-0 transition-all duration-300">
    <!-- Header -->
    <header class="h-20 px-6 flex items-center justify-between glass md:m-6 mt-4 mx-4 mb-2 z-20">
      <div class="flex items-center gap-4">
        <!-- Hamburger Button -->
        <button id="mobile-menu-btn" onclick="toggleMobileMenu()"
          class="md:hidden text-white p-2 rounded-md hover:bg-white/10 transition-colors">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <div
          class="text-xs font-bold text-success flex items-center gap-2 px-3 py-1.5 rounded-full bg-success/10 border border-success/20 shadow-glow">
          <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
          Online
        </div>
      </div>
      <div class="flex flex-col">
        <div class="text-muted text-xs font-medium mb-1"><span class="opacity-50">Pages</span> / <span
            class="text-white" id="page-title">Overview</span></div>
        <h1 class="font-bold text-sm tracking-tight text-white" id="page-hero-title">Dashboard</h1>
        <div class="text-xs text-muted mt-1" id="welcome-message"></div>
      </div>

      <div class="flex items-center gap-4">
        <!-- Search / Input imitation -->
        <div class="relative hidden md:block">
          <input type="text" placeholder="Type here..." class="glass-input pl-9 pr-4 py-2 text-xs w-48 focus:w-64">
          <svg class="absolute left-3 top-2.5 text-muted transition-colors" width="12" height="12" fill="none"
            stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>

        <div class="flex items-center gap-3">
          <button class="text-muted hover:text-white transition" onclick="toggleAutoRefresh()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6" />
              <path d="M1 20v-6h6" />
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
            </svg>
          </button>
          <button class="text-muted hover:text-white transition">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
              <path d="M13.73 21a2 2 0 0 1-3.46 0" />
            </svg>
          </button>
          <div class="text-xs font-bold text-muted flex items-center gap-2 cursor-pointer hover:text-white transition">
            <div class="w-6 h-6 rounded-full bg-accent flex items-center justify-center text-white">M</div>
            <span class="hidden md:inline">Management</span>
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 overflow-x-hidden overflow-y-auto p-6 scroll-smooth">
      <!-- Content Wrapper for Tabs -->
      <div id="tab-overview" class="space-y-6 animate-fade-in">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="md:col-span-2 glass rounded-xl p-6 relative overflow-hidden group">
            <div
              class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition text-9xl leading-none select-none">
              ‚ö°</div>
            <h2 class="text-sm font-bold text-muted uppercase tracking-wider mb-4">Server Status</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <div class="text-xs text-muted mb-1">Status</div>
                <div class="text-success font-bold flex items-center"><span class="indicator green"></span>Connected
                </div>
              </div>
              <div>
                <div class="text-xs text-muted mb-1">Host:Port</div>
                <div class="font-bold" id="host-port">Loading...</div>
              </div>
              <div>
                <div class="text-xs text-muted mb-1">Debug Mode</div>
                <div class="text-warning font-bold" id="debug-mode">Loading...</div>
              </div>
              <div>
                <div class="text-xs text-muted mb-1">Stats Enabled</div>
                <div class="text-success font-bold" id="stats-enabled">Yes</div>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl p-6">
            <h2 class="text-sm font-bold text-muted uppercase tracking-wider mb-4">Quick Actions</h2>
            <div class="space-y-3">
              <button onclick="clearLogsApi()"
                class="w-full btn bg-card border border-white/10 hover:border-danger/50 hover:bg-danger/10 text-left px-4 py-3 rounded-lg flex items-center justify-between group"><span
                  class="flex items-center"><span class="text-danger mr-2">üóë</span> Clear Logs</span><span
                  class="text-muted text-xs group-hover:text-danger">Action</span></button>
              <button onclick="switchTab('config')"
                class="w-full btn bg-card border border-white/10 hover:border-accent/50 hover:bg-accent/10 text-left px-4 py-3 rounded-lg flex items-center justify-between group"><span
                  class="flex items-center"><span class="text-accent mr-2">‚öô</span> Config Manager</span><span
                  class="text-muted text-xs group-hover:text-accent">View</span></button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="glass rounded-xl p-6">
            <div class="flex justify-between items-start mb-6">
              <h2 class="text-sm font-bold text-muted uppercase tracking-wider">Usage Statistics</h2>
            </div>
            <div class="grid grid-cols-2 gap-6">
              <div class="relative overflow-hidden group">
                <div class="text-xs text-muted mb-1 relative z-10">Total Requests</div>
                <div class="text-4xl font-bold text-accent relative z-10" id="total-requests">0</div>
                <!-- Sparkline Canvas -->
                <div class="absolute bottom-0 left-0 w-full h-12 opacity-30 group-hover:opacity-50 transition-opacity">
                  <canvas id="sparkline-requests"></canvas>
                </div>
              </div>
              <div class="relative overflow-hidden group">
                <div class="text-xs text-muted mb-1 relative z-10">Total Tokens</div>
                <div class="text-4xl font-bold text-purple-400 relative z-10" id="total-tokens">0</div>
                <!-- Sparkline Canvas (Using same trend for visual liveliness) -->
                <div class="absolute bottom-0 left-0 w-full h-12 opacity-30 group-hover:opacity-50 transition-opacity">
                  <canvas id="sparkline-tokens"></canvas>
                </div>
              </div>
              <div>
                <div class="text-xs text-muted mb-1">Success</div>
                <div class="text-xl font-bold text-success" id="success-count">0</div>
              </div>
              <div>
                <div class="text-xs text-muted mb-1">Failed</div>
                <div class="text-xl font-bold text-danger" id="failed-count">0</div>
              </div>
              <div class="col-span-2 border-t border-white/10 pt-4 mt-2">
                <div class="grid grid-cols-3 gap-4 text-center">
                  <div>
                    <div class="text-[10px] text-muted uppercase tracking-wider mb-1">Saved Cost (24h)</div>
                    <div class="text-xl font-bold text-green-400" id="cost-24h">$-</div>
                  </div>
                  <div class="border-l border-white/10">
                    <div class="text-[10px] text-muted uppercase tracking-wider mb-1">Saved Cost (7d)</div>
                    <div class="text-xl font-bold text-green-400" id="cost-7d">$-</div>
                  </div>
                  <div class="border-l border-white/10">
                    <div class="text-[10px] text-muted uppercase tracking-wider mb-1">Lifetime Saved</div>
                    <div class="text-xl font-bold text-green-400" id="cost-total">$-</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl p-6 flex flex-col">
            <div class="flex justify-between items-start mb-4">
              <h2 class="text-sm font-bold text-muted uppercase tracking-wider flex items-center gap-2">
                <span class="text-lg">üèÜ</span> Model Leaderboard
              </h2>
            </div>
            <div id="top-models-list" class="flex-1 overflow-y-auto space-y-2 pr-2 text-sm max-h-48">
              <div class="text-muted text-center py-4">Loading models...</div>
            </div>
          </div>
        </div>

        <!-- Account Health Grid -->
        <div class="glass rounded-xl p-6">
          <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
              <h2 class="text-sm font-bold text-muted uppercase tracking-wider">Account Health</h2>
              <button onclick="openAddAccountModal()"
                class="text-xs bg-accent hover:bg-blue-600 text-white px-3 py-1 rounded transition-colors">+ Add
                Account</button>
              <button onclick="exportAccountsBundle()"
                class="text-xs bg-white/5 hover:bg-white/10 text-muted hover:text-white px-3 py-1 rounded border border-white/10 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="w-3 h-3">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                Export Bundle
              </button>
            </div>
            <div class="text-xs text-muted" id="total-accounts-badge">0 total accounts</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="auth-grid"></div>
        </div>
      </div>

      <!-- Advanced Keys Tab -->
      <div id="tab-advanced-keys" class="hidden space-y-6 animate-fade-in">
        <div class="glass rounded-xl p-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-lg font-bold">Managed API Keys</h2>
              <p class="text-sm text-muted">Create and manage API keys with usage quotas and model restrictions.</p>
            </div>
            <button onclick="openCreateKeyModal()"
              class="btn bg-accent text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Create Key
            </button>
          </div>

          <!-- Keys List Container -->
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="text-xs text-muted uppercase border-b border-white/10">
                  <th class="py-3 px-4 font-semibold">Key Label</th>
                  <th class="py-3 px-4 font-semibold">Prefix</th>
                  <th class="py-3 px-4 font-semibold">Usage / Quota (USD)</th>
                  <th class="py-3 px-4 font-semibold">Rate Limit</th>
                  <th class="py-3 px-4 font-semibold">Status</th>
                  <th class="py-3 px-4 font-semibold text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="keys-table-body" class="text-sm divide-y divide-white/5">
                <!-- Keys will be populated here -->
                <tr>
                  <td colspan="6" class="py-8 text-center text-muted">Loading keys...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Create Key Modal -->
      <div id="create-key-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCreateKeyModal()"></div>
        <div
          class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg glass-no-hover p-6 rounded-2xl shadow-2xl border border-white/10">
          <h3 class="text-xl font-bold mb-4">Create New API Key</h3>
          <form id="create-key-form" onsubmit="handleCreateKey(event)">
            <div class="space-y-4">
              <div>
                <label class="block text-xs text-muted uppercase font-bold mb-2">Label (Description)</label>
                <input type="text" name="label" required placeholder="e.g. Client X Production"
                  class="w-full glass-input px-4 py-2 text-sm">
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-muted uppercase font-bold mb-2">Quota Limit (USD)</label>
                  <input type="number" name="quota_limit_usd" step="0.01" min="0" placeholder="0.00"
                    class="w-full glass-input px-4 py-2 text-sm">
                  <p class="text-[10px] text-muted mt-1">Leave 0 for unlimited</p>
                </div>
                <div>
                  <label class="block text-xs text-muted uppercase font-bold mb-2">Rate Limit (RPM)</label>
                  <input type="number" name="rate_limit_rpm" step="1" min="0" placeholder="60"
                    class="w-full glass-input px-4 py-2 text-sm">
                  <p class="text-[10px] text-muted mt-1">Requests per minute. 0 = unlimited</p>
                </div>
              </div>

              <div>
                <label class="block text-xs text-muted uppercase font-bold mb-2">Request Limit (Optional)</label>
                <input type="number" name="quota_limit_requests" step="1" min="0" placeholder="1000"
                  class="w-full glass-input px-4 py-2 text-sm">
                <p class="text-[10px] text-muted mt-1">Total max requests. 0 = unlimited</p>
              </div>

              <div>
                <label class="block text-xs text-muted uppercase font-bold mb-2">Expiration (Optional)</label>
                <input type="datetime-local" name="expires_at"
                  class="w-full glass-input px-4 py-2 text-sm text-white dark-calendar">
              </div>

              <div>
                <label class="block text-xs text-muted uppercase font-bold mb-2">Allowed Models</label>
                <!-- Quick Select Toolbar -->
                <div class="flex flex-wrap gap-2 mb-2">
                  <button type="button" onclick="selectAllModels(true)"
                    class="text-[10px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-white transition">All</button>
                  <button type="button" onclick="selectAllModels(false)"
                    class="text-[10px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-white transition">None</button>
                  <div class="w-px h-4 bg-white/10 mx-1 self-center"></div>
                  <button type="button" onclick="selectModelsByProvider('gemini')"
                    class="text-[10px] bg-blue-900/30 hover:bg-blue-900/50 px-2 py-1 rounded text-blue-300 border border-blue-500/30 transition">Gemini</button>
                  <button type="button" onclick="selectModelsByProvider('gpt')"
                    class="text-[10px] bg-green-900/30 hover:bg-green-900/50 px-2 py-1 rounded text-green-300 border border-green-500/30 transition">GPT</button>
                  <button type="button" onclick="selectModelsByProvider('claude')"
                    class="text-[10px] bg-orange-900/30 hover:bg-orange-900/50 px-2 py-1 rounded text-orange-300 border border-orange-500/30 transition">Claude</button>
                  <button type="button" onclick="selectModelsByProvider('o1')"
                    class="text-[10px] bg-pink-900/30 hover:bg-pink-900/50 px-2 py-1 rounded text-pink-300 border border-pink-500/30 transition">o1</button>
                </div>
                <div class="glass-input p-3 h-32 overflow-y-auto text-sm space-y-2" id="create-key-model-selector">
                  <div class="text-center text-muted text-xs py-2">Loading models...</div>
                </div>
                <p class="text-[10px] text-muted mt-1">Select specific models. Leave all unchecked to allow ALL models.
                </p>
              </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
              <button type="button" onclick="closeCreateKeyModal()"
                class="px-4 py-2 rounded-lg text-sm font-bold text-muted hover:text-white transition">Cancel</button>
              <button type="submit" class="btn bg-accent text-white px-6 py-2 rounded-lg text-sm font-bold">Create
                Key</button>
            </div>
          </form>
        </div>
      </div>

      <!-- New Key Display Modal -->
      <div id="new-key-display-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div
          class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md glass-no-hover p-8 rounded-2xl shadow-2xl border border-accent/20 text-center">
          <div class="w-16 h-16 bg-success/20 text-success rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h3 class="text-2xl font-bold mb-2">Key Created Successfully</h3>
          <p class="text-muted text-sm mb-6">Please copy your API key now. It will not be shown again.</p>

          <div class="relative mb-6">
            <input type="text" id="new-key-value" readonly
              class="w-full glass-input py-3 px-4 text-center font-mono text-accent font-bold text-lg border-accent/30 bg-accent/5"
              value="sk-...">
            <button onclick="copyNewKey()"
              class="absolute right-2 top-1/2 -translate-y-1/2 p-2 hover:bg-white/10 rounded">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                </path>
              </svg>
            </button>
          </div>

          <button onclick="closeNewKeyModal()"
            class="btn w-full bg-white text-black hover:bg-gray-200 px-6 py-3 rounded-lg text-sm font-bold">
            I have saved the key
          </button>
        </div>
      </div>

      <!-- Config Tab -->
      <div id="tab-config" class="hidden space-y-6">
        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold text-muted uppercase tracking-wider">Quick Settings</h2><span
              class="text-xs text-muted">Changes apply immediately</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="flex items-center justify-between bg-white/5 p-4 rounded-lg">
              <span class="font-medium text-sm">Debug Mode</span>
              <label class="ui-switch">
                <input type="checkbox" id="cfg-debug" onchange="updateConfig('debug', this.checked)">
                <div class="ui-switch-track"></div>
                <div class="ui-switch-thumb"></div>
              </label>
            </div>
            <div class="flex items-center justify-between bg-white/5 p-4 rounded-lg">
              <span class="font-medium text-sm">Usage Stats</span>
              <label class="ui-switch">
                <input type="checkbox" id="cfg-usage" onchange="updateConfig('usage-statistics-enabled', this.checked)">
                <div class="ui-switch-track"></div>
                <div class="ui-switch-thumb"></div>
              </label>
            </div>
            <div class="flex items-center justify-between bg-white/5 p-4 rounded-lg">
              <span class="font-medium text-sm">Request Log</span>
              <label class="ui-switch">
                <input type="checkbox" id="cfg-reqlog" onchange="updateConfig('request-log', this.checked)">
                <div class="ui-switch-track"></div>
                <div class="ui-switch-thumb"></div>
              </label>
            </div>
          </div>
        </div>
        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold text-muted uppercase tracking-wider">Client API Keys</h2><button
              onclick="addClientKey()" class="text-xs bg-accent hover:bg-blue-600 text-white px-3 py-1 rounded">Add
              Key</button>
          </div>
          <div id="api-keys-list" class="space-y-2">
            <div class="text-muted text-sm">Loading keys...</div>
          </div>
        </div>
        <div class="glass rounded-xl p-6 flex flex-col h-[500px]">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold text-muted uppercase tracking-wider">Raw Config Editor</h2><button
              onclick="saveRawConfig()"
              class="text-xs bg-success hover:bg-green-600 text-white px-4 py-1.5 rounded font-bold">Save
              Config.yaml</button>
          </div>
          <textarea id="raw-config-editor"
            class="flex-1 bg-bg border border-white/10 rounded-lg p-4 font-mono text-sm leading-relaxed resize-none focus:outline-none focus:border-accent text-gray-300"
            spellcheck="false"></textarea>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="tab-logs" class="hidden h-[calc(100vh-8rem)] flex flex-col">
        <div class="glass rounded-xl flex-1 flex flex-col overflow-hidden">
          <div class="h-12 border-b border-white/5 flex items-center justify-between px-4 bg-card/30">
            <div class="flex items-center space-x-4">
              <h2 class="text-sm font-bold text-muted uppercase tracking-wider">Live Server Logs</h2>
              <span id="log-status" class="text-xs text-muted">Loading...</span>
            </div>
            <div class="flex items-center space-x-3">
              <label class="flex items-center text-xs text-muted cursor-pointer"><input type="checkbox"
                  id="log-autoscroll" checked class="mr-2 accent-accent"> Auto-scroll</label>
              <button onclick="clearLogView()" class="text-xs text-muted hover:text-danger btn">Clear View</button>
            </div>
          </div>
          <div id="log-terminal" class="flex-1 overflow-y-auto p-4 whitespace-pre-wrap break-all"></div>
        </div>
      </div>

      <!-- Activity Tab -->
      <div id="tab-activity" class="hidden space-y-6">
        <!-- Analytics Chart -->
        <div class="glass rounded-xl p-6">
          <h2 class="text-sm font-bold text-muted uppercase tracking-wider mb-4">Usage Trends (Last 24 Hours)</h2>
          <div class="h-64 relative">
            <!-- Skeleton for Chart -->
            <div id="chart-skeleton"
              class="absolute inset-0 flex items-center justify-center bg-white/5 rounded-xl animate-pulse">
              <div class="text-muted text-xs font-mono">Loading Chart Data...</div>
            </div>
            <canvas id="usage-chart" class="opacity-0 transition-opacity duration-500"></canvas>
          </div>
        </div>

        <div class="glass rounded-xl p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Activity History</h2>
            <div class="flex space-x-2">
              <select id="activity-model-filter" onchange="loadActivityLogs()"
                class="bg-bg border border-white/10 rounded px-2 py-1 text-xs text-muted focus:outline-none focus:border-accent">
                <option value="">All Models</option>
                <!-- Populated by JS -->
              </select>
              <select id="activity-status-filter" onchange="loadActivityLogs()"
                class="bg-bg border border-white/10 rounded px-2 py-1 text-xs text-muted focus:outline-none focus:border-accent">
                <option value="">All Status</option>
                <option value="success">Success</option>
                <option value="failure">Failure</option>
              </select>
              <button onclick="exportActivityLogs()"
                class="text-xs border border-white/20 hover:bg-white/10 text-white btn px-3 transition-colors">Export
                CSV</button>
              <button onclick="loadActivityLogs()" class="text-xs text-muted hover:text-white btn">Refresh</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <div class="overflow-x-auto w-full">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-muted uppercase bg-white/5">
                  <tr>
                    <th class="py-3 px-2 rounded-tl-lg">Time</th>
                    <th class="py-3 px-2">Model</th>
                    <th class="py-3 px-2">Source</th>
                    <th class="py-3 px-2">Tokens (In/Out)</th>
                    <th class="py-3 px-2">Cost</th>
                    <th class="py-3 px-2">Duration</th>
                    <th class="py-3 px-2">Status</th>
                    <th class="py-3 px-2 rounded-tr-lg">Action</th>
                  </tr>
                </thead>
                <tbody id="activity-table-body" class="divide-y divide-white/5">
                  <tr>
                    <td colspan="8" class="text-center py-8 text-muted">Loading logs...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="mt-4 flex justify-between items-center text-xs text-muted">
            <div id="activity-pagination-info">Showing recent activities</div>
          </div>
        </div>
      </div>

      <!-- Modal for details -->
      <!-- Activity Modal (Existing) -->
      <div id="activity-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <!-- Content moved inside -->
        <div class="bg-card rounded-xl max-w-4xl w-full max-h-[90vh] flex flex-col shadow-2xl border border-white/10">
          <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="font-bold">Request Details</h3>
            <button onclick="closeActivityModal()" class="text-muted hover:text-white">&times;</button>
          </div>
          <div class="p-6 overflow-y-auto space-y-4 font-mono text-xs">
            <div>
              <label class="block text-muted uppercase font-bold mb-1">Detailed Info</label>
              <pre id="modal-meta" class="bg-bg p-3 rounded overflow-x-auto"></pre>
            </div>
            <div>
              <label class="block text-muted uppercase font-bold mb-1">Prompt</label>
              <pre id="modal-prompt" class="bg-bg p-3 rounded overflow-x-auto whitespace-pre-wrap"></pre>
            </div>
            <div>
              <label id="modal-completion-label" class="block text-muted uppercase font-bold mb-1">Response</label>
              <pre id="modal-completion" class="bg-bg p-3 rounded overflow-x-auto whitespace-pre-wrap"></pre>
            </div>
          </div>
          <div class="p-4 border-t border-white/10 flex justify-end gap-2">
            <button onclick="closeActivityModal()"
              class="px-3 py-2 rounded text-xs text-muted hover:text-white transition-colors">Close</button>
            <button id="modal-replay-btn"
              class="bg-accent hover:bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold transition-colors flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
              Replay in Playground
            </button>
          </div>
        </div>
      </div>

      <!-- Donation Modal -->
      <div id="donation-modal"
        class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
          class="glass max-w-md w-full p-6 relative animate-fade-in border border-yellow-500/20 max-h-[90vh] overflow-y-auto">
          <button onclick="closeDonationModal()" class="absolute top-4 right-4 text-muted hover:text-white transition">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>

          <div class="text-center mb-6">
            <div
              class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl animate-bounce">
              ‚òï</div>
            <h2 class="text-xl font-bold text-white mb-1">Buy Me a Coffee</h2>
            <p class="text-xs text-muted">Support development & server costs</p>
          </div>

          <!-- Tabs -->
          <div class="flex border-b border-white/10 mb-4">
            <button onclick="switchDonationTab('vn')" id="tab-btn-vn"
              class="flex-1 pb-2 text-sm font-bold text-yellow-400 border-b-2 border-yellow-400 transition-colors">Vietnam
              (QR)</button>
            <button onclick="switchDonationTab('global')" id="tab-btn-global"
              class="flex-1 pb-2 text-sm font-bold text-muted hover:text-white border-b-2 border-transparent transition-colors">Global
              (Crypto/Paypal)</button>
          </div>

          <!-- Content: Vietnam -->
          <div id="donation-content-vn" class="text-center animate-fade-in">
            <div
              class="bg-white p-2 rounded-lg inline-block mb-4 shadow-lg shadow-yellow-500/10 hover:scale-[1.02] transition-transform">
              <img src="/static/QR%20Vietcombank.png" alt="Scan to Donate" class="w-48 h-48 object-contain">
            </div>
            <p class="text-[10px] text-muted italic">Scan via Banking App (Vietcombank)</p>
          </div>

          <!-- Content: Global -->
          <div id="donation-content-global" class="hidden space-y-4 animate-fade-in">

            <!-- Paypal -->
            <div class="bg-black/30 rounded-lg p-3 border border-white/5 group hover:border-blue-500/30 transition">
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2 text-blue-400 font-bold text-xs"><svg class="w-4 h-4"
                    fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M7.076 21.337l.796-5.071c.081-.516.527-.899 1.05-.899h2.373c2.723 0 4.254-1.328 4.887-4.526.476-2.42-1.07-3.957-4.088-3.957h-3.41c-.495 0-.916.357-.992.846L5.356 19.986c-.059.38.235.733.626.733h1.094z" />
                  </svg> Paypal</div>
              </div>
              <div class="flex items-center justify-between bg-bg/50 rounded px-2 py-1.5">
                <code class="text-[11px] text-muted truncate select-all">wikigamingmovies@gmail.com</code>
                <button onclick="copyText('wikigamingmovies@gmail.com')"
                  class="text-blue-400 hover:text-white p-1 ml-2"><svg class="w-3.5 h-3.5" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg></button>
              </div>
            </div>

            <!-- USDT TRC20 -->
            <div class="bg-black/30 rounded-lg p-3 border border-white/5 group hover:border-green-500/30 transition">
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2 text-green-400 font-bold text-xs">‚ÇÆ USDT (TRC20)</div>
              </div>
              <div class="flex items-center justify-between bg-bg/50 rounded px-2 py-1.5">
                <input type="text" value="TNGsaurWeFhaPPs1yxJ3AY15j1tDecX7ya"
                  class="bg-transparent border-none text-[11px] text-muted w-full focus:outline-none" readonly
                  id="wallet-trc20">
                <button onclick="copyInput('wallet-trc20')" class="text-green-400 hover:text-white p-1 ml-2"><svg
                    class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg></button>
              </div>
            </div>

            <!-- USDT BEP20 -->
            <div class="bg-black/30 rounded-lg p-3 border border-white/5 group hover:border-yellow-500/30 transition">
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2 text-yellow-400 font-bold text-xs">‚ÇÆ USDT (BEP20)</div>
              </div>
              <div class="flex items-center justify-between bg-bg/50 rounded px-2 py-1.5">
                <input type="text" value="0x463695638788279F234386a77E0afA2Ee87b57F5"
                  class="bg-transparent border-none text-[11px] text-muted w-full focus:outline-none" readonly
                  id="wallet-bep20">
                <button onclick="copyInput('wallet-bep20')" class="text-yellow-400 hover:text-white p-1 ml-2"><svg
                    class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg></button>
              </div>
            </div>

            <!-- Solana -->
            <div class="bg-black/30 rounded-lg p-3 border border-white/5 group hover:border-purple-500/30 transition">
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2 text-purple-400 font-bold text-xs">‚óé Solana (SOL)</div>
              </div>
              <div class="flex items-center justify-between bg-bg/50 rounded px-2 py-1.5">
                <input type="text" value="HkgpzujF8uTBuYEYGSFMnmGzBYmEFyajzTiZacRtXzTr"
                  class="bg-transparent border-none text-[11px] text-muted w-full focus:outline-none" readonly
                  id="wallet-solana">
                <button onclick="copyInput('wallet-solana')" class="text-purple-400 hover:text-white p-1 ml-2"><svg
                    class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg></button>
              </div>
            </div>

          </div>
        </div>
      </div>


      <!-- Modal for Adding Account -->
      <div id="add-account-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-card rounded-xl max-w-lg w-full shadow-2xl border border-white/10 flex flex-col">
          <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="font-bold">Add Account / Key</h3>
            <button onclick="closeAddAccountModal()" class="text-muted hover:text-white">&times;</button>
          </div>
          <div class="p-6 space-y-6">
            <!-- Option 1: Connect Provider -->
            <div>
              <label class="block text-sm font-bold text-muted mb-2 uppercase tracking-wide">Option 1: Connect
                Provider</label>
              <div class="grid grid-cols-2 gap-2">
                <button onclick="startAuth('antigravity')"
                  class="flex items-center justify-center gap-2 p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-yellow-500/50 transition-all group">
                  <span class="text-sm font-bold group-hover:text-yellow-500">Antigravity</span>
                </button>
                <button onclick="startAuth('gemini-cli')"
                  class="flex items-center justify-center gap-2 p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-blue-500/50 transition-all group">
                  <span class="text-sm font-bold group-hover:text-blue-500">Gemini CLI</span>
                </button>
                <button onclick="startAuth('anthropic')"
                  class="flex items-center justify-center gap-2 p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-orange-500/50 transition-all group">
                  <span class="text-sm font-bold group-hover:text-orange-500">Anthropic</span>
                </button>
                <button onclick="startAuth('iflow')"
                  class="flex items-center justify-center gap-2 p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-cyan-500/50 transition-all group">
                  <span class="text-sm font-bold group-hover:text-cyan-500">iFlow</span>
                </button>
              </div>
            </div>

            <div class="relative flex py-2 items-center">
              <div class="flex-grow border-t border-white/10"></div>
              <span class="flex-shrink-0 mx-4 text-muted text-xs uppercase">Or</span>
              <div class="flex-grow border-t border-white/10"></div>
            </div>

            <!-- Option 2: Upload File -->
            <div>
              <label class="block text-sm font-bold text-muted mb-2 uppercase tracking-wide">Option 2: Import Auth
                File</label>
              <div class="relative group">
                <input type="file" id="auth-file-input" accept=".json"
                  class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-white/10 file:text-white hover:file:bg-white/20 cursor-pointer border border-white/10 rounded-lg p-2 bg-bg focus:border-accent focus:outline-none transition-colors">
                <p class="text-xs text-muted mt-2">Upload a JSON key file (e.g. <code>gemini-key.json</code>,
                  <code>claude-token.json</code>) to the <code>auths/</code> directory.
                </p>
              </div>
            </div>

            <div class="relative flex py-2 items-center">
              <div class="flex-grow border-t border-white/10"></div>
              <span class="flex-shrink-0 mx-4 text-muted text-xs uppercase">Or</span>
              <div class="flex-grow border-t border-white/10"></div>
            </div>

            <!-- Option 3: Paste JSON -->
            <div>
              <label class="block text-sm font-bold text-muted mb-2 uppercase tracking-wide">Option 3: Paste JSON
                Content</label>
              <textarea id="auth-json-content" rows="4"
                class="w-full bg-bg border border-white/10 rounded-lg p-3 font-mono text-xs focus:outline-none focus:border-accent resize-none placeholder-white/20"
                placeholder='{"provider": "gemini", "api_key": "..."}'></textarea>
              <input type="text" id="auth-file-name" placeholder="Filename (e.g. my-key.json)"
                class="mt-2 w-full bg-bg border border-white/10 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-accent">
            </div>
            <!-- Option 4: Import Bundle (ZIP) -->
            <div>
              <label class="block text-sm font-bold text-muted mb-2 uppercase tracking-wide">Option 4: Import Accounts
                Bundle (ZIP)</label>
              <div class="flex gap-2">
                <input type="file" id="auth-bundle-input" accept=".zip"
                  class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-white/10 file:text-white hover:file:bg-white/20 cursor-pointer border border-white/10 rounded-lg p-2 bg-bg focus:border-accent focus:outline-none transition-colors">
                <button onclick="importAccountsBundle()"
                  class="bg-accent hover:bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold transition-all whitespace-nowrap">Import
                  Bundle</button>
              </div>
              <p class="text-[10px] text-muted mt-2">Upload a ZIP bundle containing account JSON files to import them
                all at once.</p>
            </div>
          </div>
          <div class="p-4 border-t border-white/10 flex justify-end gap-2 bg-card/50 rounded-b-xl">
            <button onclick="closeAddAccountModal()"
              class="px-4 py-2 rounded text-xs font-medium text-muted hover:text-white transition-colors">Cancel</button>
            <button onclick="importAuthFile()"
              class="bg-accent hover:bg-blue-600 text-white px-6 py-2 rounded text-xs font-bold transition-transform active:scale-95 shadow-lg shadow-blue-500/20">Import
              Account</button>
          </div>
        </div>
      </div>

      <!-- Chat Playground Tab -->
      <div id="tab-playground" class="hidden h-full flex gap-6 pb-6">
        <!-- Sidebar -->
        <div class="w-64 glass rounded-xl p-4 flex flex-col space-y-4 shrink-0 overflow-y-auto">
          <div>
            <label class="text-xs text-muted uppercase font-bold tracking-wider mb-2 block">Model</label>
            <select id="model-select"
              class="w-full bg-bg border border-white/10 rounded px-3 py-2 text-sm focus:outline-none focus:border-accent appearance-none">
              <option value="" disabled selected>Loading...</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-muted uppercase font-bold tracking-wider mb-2 block">System Prompt</label>
            <textarea id="system-prompt" rows="5"
              class="w-full bg-bg border border-white/10 rounded px-3 py-2 text-xs focus:outline-none focus:border-accent resize-none p-2"
              placeholder="You are a helpful assistant..."></textarea>
          </div>

          <div class="border-t border-white/10 pt-4">
            <label class="text-xs text-muted uppercase font-bold tracking-wider mb-2 block">Settings</label>
            <div class="space-y-4">
              <div>
                <div class="flex justify-between text-xs mb-1">
                  <span class="text-muted">Temperature</span>
                  <span id="temp-val" class="text-accent">0.7</span>
                </div>
                <input type="range" id="temp-input" min="0" max="2" step="0.1" value="0.7"
                  class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-accent"
                  oninput="document.getElementById('temp-val').textContent = this.value">
              </div>
              <div>
                <div class="flex justify-between text-xs mb-1">
                  <span class="text-muted">Top P</span>
                  <span id="topp-val" class="text-accent">1.0</span>
                </div>
                <input type="range" id="topp-input" min="0" max="1" step="0.05" value="1.0"
                  class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-accent"
                  oninput="document.getElementById('topp-val').textContent = this.value">
              </div>
              <div>
                <label class="text-xs text-muted block mb-1">Max Tokens</label>
                <input type="number" id="maxtokens-input" value="1024"
                  class="w-full bg-bg border border-white/10 rounded px-2 py-1 text-xs focus:outline-none focus:border-accent">
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-muted">Show Thinking</span>
                <div class="relative block w-8 h-4">
                  <input type="checkbox" id="show-thinking-toggle" class="toggle-checkbox"
                    style="width: 1rem; height: 1rem;" checked>
                  <div class="w-8 h-4 bg-white/10 rounded-full transition-colors"></div>
                  <div class="dot absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full transition transform">
                  </div>
                </div>
                <style>
                  #show-thinking-toggle:checked+div {
                    background-color: #3B82F6;
                  }

                  #show-thinking-toggle:checked~.dot {
                    transform: translateX(100%) translateX(2px);
                  }
                </style>
              </div>
            </div>
          </div>

          <div class="flex-1"></div>
          <button onclick="clearChat()"
            class="w-full text-xs text-muted hover:text-danger btn border border-white/10 rounded px-3 py-2">Clear
            History</button>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 glass rounded-xl flex flex-col overflow-hidden relative">
          <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-6">
            <div class="text-center text-muted text-sm py-20 flex flex-col items-center opacity-50">
              <div class="text-4xl mb-4">üí¨</div>
              <div>Select a model to start chatting</div>
            </div>
          </div>

          <!-- Image Preview Area -->
          <div id="image-preview-container"
            class="hidden px-4 pt-2 border-t border-white/5 bg-card/30 flex gap-2 overflow-x-auto">
            <!-- Previews inserted here -->
          </div>

          <!-- Input Area -->
          <div class="p-4 bg-card/50 border-t border-white/5">
            <div
              class="flex items-end gap-2 bg-bg border border-white/10 rounded-xl p-2 focus-within:border-accent transition-colors">
              <button onclick="document.getElementById('file-input').click()"
                class="text-muted hover:text-white p-2 rounded-lg transition-colors" title="Attach image">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13" />
                </svg>
              </button>
              <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileUpload(this)">

              <textarea id="chat-input" rows="1"
                class="flex-1 bg-transparent border-none text-sm focus:outline-none resize-none py-2 max-h-32 min-h-[36px]"
                placeholder="Type your message... (Shift+Enter for new line)"></textarea>

              <button onclick="sendMessage()" id="send-btn"
                class="bg-accent hover:bg-blue-600 text-white rounded-lg p-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                  <path
                    d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
                </svg>
              </button>
            </div>
            <div id="typing-indicator" class="text-xs text-muted mt-2 ml-2 hidden flex items-center gap-2">
              <span class="indicator green animate-pulse" style="width: 6px; height: 6px;"></span> Generating
              response...
            </div>
          </div>
        </div>
      </div>
    </div> <!-- End Main Content Scroll -->

    <!-- Footer Stats Bar -->
    <footer
      class="h-10 px-6 flex items-center justify-between bg-black/30 border-t border-white/5 text-xs text-muted shrink-0">
      <div class="flex items-center gap-6">
        <span class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 bg-success rounded-full animate-pulse"></span>
          Uptime: <span id="footer-uptime">--</span></span>
        <span>Last Sync: <span id="footer-last-sync">--</span></span>
      </div>
      <div class="flex items-center gap-4">
        <span>CLIProxy <span class="text-accent">v6.0</span></span>
      </div>
    </footer>
  </main>

  <!-- Quick Actions FAB -->
  <div class="fixed bottom-6 right-6 z-40 flex flex-col items-end gap-2">
    <button onclick="openAddAccountModal()" title="Add Account"
      class="w-12 h-12 rounded-full bg-accent hover:bg-accent-hover text-white shadow-lg hover:shadow-glow flex items-center justify-center transition-all hover:scale-110">
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
    </button>
  </div>
</body>

<div id="toast"
  class="fixed bottom-4 right-4 bg-card border border-white/10 px-4 py-3 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-300 z-50">
  <span id="toast-msg">Notification</span>
</div>

<script>
  // Dynamic Auth Logic
  // TO HARDCODE KEY: Enter your key below, e.g. const HARDCODED_KEY = 'my-secret-key';
  const HARDCODED_KEY = '';

  if (HARDCODED_KEY) {
    localStorage.setItem('mgmt_key', HARDCODED_KEY);
  }

  const urlParams = new URLSearchParams(window.location.search);
  const urlKey = urlParams.get('key');
  if (urlKey) {
    localStorage.setItem('mgmt_key', urlKey);
  }

  let MANAGEMENT_KEY = localStorage.getItem('mgmt_key');

  if (!MANAGEMENT_KEY) {
    // Small timeout to Ensure UI renders first or just prompt
    MANAGEMENT_KEY = prompt("üîë Authentication Required\n\nPlease enter your Management Secret Key securely:", "");
    if (MANAGEMENT_KEY) {
      localStorage.setItem('mgmt_key', MANAGEMENT_KEY);
    }
  }

  if (!MANAGEMENT_KEY) {
    // Fallback to prevent null reference errors, but UI will likely fail nicely or auth check will catch it
    console.warn("No management key provided. Dashboard features will be limited.");
  }
  let logPollInterval = null;
  let autoRefreshInterval = null;
  let latestLogTimestamp = 0;
  let hasAnimatedOverview = false; // --- Initialize ---
  document.addEventListener('DOMContentLoaded', () => {
    // Force visibility of overview tab
    document.getElementById('tab-overview').classList.remove('hidden');

    // Inject hidden toggle if missing (since we removed it from top nav)
    if (!document.getElementById('auto-refresh-toggle')) {
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = 'auto-refresh-toggle';
      input.className = 'hidden';
      input.checked = localStorage.getItem('auto_refresh') === 'true';
      document.body.appendChild(input);
    }

    const ar = localStorage.getItem('auto_refresh') === 'true';
    const toggle = document.getElementById('auto-refresh-toggle');
    if (toggle) toggle.checked = ar;
    if (ar) startAutoRefresh();

    // Pre-load models for playground
    loadModels();
  });

  function toggleAutoRefresh() {
    const toggle = document.getElementById('auto-refresh-toggle');
    localStorage.setItem('auto_refresh', toggle.checked);
    if (toggle.checked) startAutoRefresh();
    else stopAutoRefresh();
  }

  // Mobile Menu Toggle
  function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('sidebar-backdrop');

    if (sidebar.classList.contains('-translate-x-full')) {
      // Open menu
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      backdrop.classList.remove('hidden');
    } else {
      // Close menu
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      backdrop.classList.add('hidden');
    }
  }

  function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(() => {
      // Refresh global header stats if needed, or active tab content
      const activeTab = document.querySelector('.tab-active').id.replace('tab-btn-', '');

      // Always fetch basic data for header/overview
      fetchData();

      if (activeTab === 'activity') {
        loadActivityLogs();
        loadUsageChart();
      }
      // Logs tab has its own poller, maybe unify later, but for now separate
    }, 5000);
  }

  function stopAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }

  function switchTab(tabId) {
    // 1. Sidebar Active State
    document.querySelectorAll('.sidebar-link').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById(`tab-btn-${tabId}`);
    if (btn) btn.classList.add('active');

    // 2. Update Header Titles
    const titles = { 'overview': 'Dashboard', 'config': 'Configuration', 'logs': 'Server Logs', 'activity': 'Activity Monitor', 'playground': 'AI Playground' };
    const titleEl = document.getElementById('page-title');
    const heroEl = document.getElementById('page-hero-title');
    if (titleEl) titleEl.textContent = tabId.charAt(0).toUpperCase() + tabId.slice(1);
    if (heroEl) heroEl.textContent = titles[tabId] || 'Dashboard';

    // 3. Toggle Content Visibility
    document.querySelectorAll('[id^="tab-"]:not([id^="tab-btn"])').forEach(content => content.classList.add('hidden'));
    const content = document.getElementById(`tab-${tabId}`);
    if (content) content.classList.remove('hidden');

    // 4. Trigger Tab Specific Logic
    if (tabId === 'config') loadConfigTab();
    if (tabId === 'logs') { startLogPolling(); } else { stopLogPolling(); }
    if (tabId === 'activity') loadActivityLogs();
    if (tabId === 'playground') loadModels();
  }

  async function checkAuth() {
    try {
      const res = await fetch(`/v0/management/get-auth-status?key=${MANAGEMENT_KEY}`, { headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } });
      if (res.status === 401 || res.status === 403) {
        const newKey = prompt("Enter Management Key (e.g. setup-secret-key):");
        if (newKey) { MANAGEMENT_KEY = newKey; localStorage.setItem('mgmt_key', newKey); location.reload(); }
      }
    } catch (e) { console.error("Auth check failed", e); }
  }

  const providerColors = { gemini: 'bg-blue-900/40 border-blue-500/30', claude: 'bg-orange-900/40 border-orange-500/30', codex: 'bg-green-900/40 border-green-500/30', qwen: 'bg-purple-900/40 border-purple-500/30', iflow: 'bg-cyan-900/40 border-cyan-500/30', vertex: 'bg-red-900/40 border-red-500/30', antigravity: 'bg-yellow-900/30 border-yellow-500/30' };

  function formatNumber(num) {
    if (num === undefined || num === null) return '0';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
    return num.toString();
  }

  // CountUp Animation Helper
  function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;
    // If end is 0, just set it
    if (end === 0) { obj.textContent = "0"; return; }

    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      const val = Math.floor(progress * (end - start) + start);

      // Format number based on context (tokens use K/M, requests use commas)
      if (id === 'total-tokens') {
        obj.textContent = formatNumber(val);
      } else {
        obj.textContent = val.toLocaleString();
      }

      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };
    window.requestAnimationFrame(step);
  }

  function formatCompactNumber(number) {
    if (number === undefined || number === null) return '0';
    return new Intl.NumberFormat('en-US', {
      notation: "compact",
      maximumFractionDigits: 2
    }).format(number);
  }

  async function fetchData() {
    const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}` };
    try {
      const res = await fetch(`/v0/management/config?key=${MANAGEMENT_KEY}`, { headers }); const config = await res.json();
      const displayPort = config.port || 8317;
      document.getElementById('host-port').textContent = `0.0.0.0:${displayPort}`;
      document.getElementById('header-host-port').textContent = `0.0.0.0:${displayPort}`;
      document.getElementById('debug-mode').textContent = config.debug ? 'Enabled' : 'Disabled';
    } catch (e) {
      // console.error(e);
      // Suppress benign errors during init
    }

    try {
      const res = await fetch(`/v0/management/usage?key=${MANAGEMENT_KEY}`, { headers }); const data = await res.json(); const usage = data.usage || {};

      // Animations: Only run once on first load
      if (!hasAnimatedOverview) {
        animateValue("total-requests", 0, usage.total_requests || 0, 1500);
        animateValue("total-tokens", 0, usage.total_tokens || 0, 1500);
        hasAnimatedOverview = true;
      } else {
        // Direct update to prevent jumping
        const reqEl = document.getElementById('total-requests');
        const tokEl = document.getElementById('total-tokens');
        // Only update text (keep style)
        if (reqEl) reqEl.textContent = (usage.total_requests || 0).toLocaleString();
        if (tokEl) tokEl.textContent = formatNumber(usage.total_tokens || 0);
      }

      document.getElementById('success-count').textContent = (usage.success_count || 0).toLocaleString();
      document.getElementById('failed-count').textContent = (usage.failure_count || 0).toLocaleString();

      // Cost (Multi-period)
      const getCostEmoji = (v) => {
        if (!v || v < 1) return 'ü™ô';    // < $1: Coin
        if (v < 10) return 'üí∏';   // < $10: Money w/ Wings
        if (v < 100) return 'üíµ';  // < $100: Banknote
        if (v < 1000) return 'üí∞'; // < $1000: Bag
        if (v < 5000) return 'üíé'; // < $5000: Gem
        return 'üöÄ';               // > $5000: Rocket
      };
      const fmtCost = (v) => {
        const val = v || 0;
        return `${getCostEmoji(val)} $${val.toFixed(4)}`;
      };
      if (document.getElementById('cost-24h')) document.getElementById('cost-24h').textContent = fmtCost(usage.cost_24h);
      if (document.getElementById('cost-7d')) document.getElementById('cost-7d').textContent = fmtCost(usage.cost_7d);
      if (document.getElementById('cost-total')) document.getElementById('cost-total').textContent = fmtCost(usage.total_cost);

      const modelsList = document.getElementById('top-models-list'); modelsList.innerHTML = '';
      let flatModels = [];
      if (usage.apis) { for (const p in usage.apis) { const pData = usage.apis[p]; if (pData.models) { for (const m in pData.models) { flatModels.push({ name: m, ...pData.models[m] }); } } } }
      flatModels.sort((a, b) => b.total_requests - a.total_requests);
      updateModelDropdown(flatModels.map(m => m.name));
      if (flatModels.length === 0) { modelsList.innerHTML = '<div class="text-muted text-center py-4 text-xs">No traffic yet</div>'; }
      else {
        flatModels.slice(0, 10).forEach((m, index) => {
          const row = document.createElement('div');
          row.className = 'flex justify-between items-center bg-white/5 p-3 rounded-lg hover:bg-white/10 transition group';

          // Ranking icons
          let rankIcon = '';
          if (index === 0) rankIcon = '<span class="text-xl mr-2">ü•á</span>';
          else if (index === 1) rankIcon = '<span class="text-xl mr-2">ü•à</span>';
          else if (index === 2) rankIcon = '<span class="text-xl mr-2">ü•â</span>';
          else rankIcon = `<span class="text-xs text-muted mr-2 w-6 text-center">#${index + 1}</span>`;

          row.innerHTML = `<div class="flex items-center">${rankIcon}<span class="font-mono text-xs truncate max-w-[150px] group-hover:text-white transition" title="${m.name}">${m.name}</span></div><div class="flex items-center gap-3 text-sm"><span class="bg-accent/20 text-accent px-2 py-0.5 rounded-full font-bold">${m.total_requests.toLocaleString()} <span class="text-[10px] opacity-70">req</span></span><span class="bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full font-bold">${formatNumber(m.total_tokens)} <span class="text-[10px] opacity-70">tok</span></span></div>`;
          modelsList.appendChild(row);
        });
      }
    } catch (e) { console.error(e) }
    try {
      const res = await fetch(`/v0/management/auth-files?key=${MANAGEMENT_KEY}`, { headers }); const data = await res.json(); const files = data.files || [];
      document.getElementById('total-accounts-badge').textContent = `${files.length} total accounts`;
      const authGrid = document.getElementById('auth-grid'); authGrid.innerHTML = '';
      files.forEach(f => {
        const color = providerColors[f.provider] || 'bg-gray-900/40 border-gray-500/30';
        const card = document.createElement('div');
        card.className = `${color} border rounded-lg p-4 group hover:scale-[1.02] hover:shadow-lg hover:shadow-accent/10 transition-all duration-200 relative`;
        const statusBadge = getStatusBadge(f.status, f.disabled, f.unavailable);
        const refreshText = formatRelativeTime(f.last_refresh);
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="font-bold truncate max-w-[60%]" title="${f.email || f.name}">${f.email || f.name}</div>
            <div class="flex items-center gap-2">
              ${statusBadge}
              <button onclick="exportAccount('${f.name}', event)"
                class="opacity-0 group-hover:opacity-100 text-blue-400 hover:text-blue-300 hover:bg-blue-500/20 p-1 rounded transition-all mr-1"
                title="Export account">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </button>
              <button onclick="deleteAccount('${f.name}', event)" 
                class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 hover:bg-red-500/20 p-1 rounded transition-all" 
                title="Delete account">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
          <div class="text-xs text-muted">${f.provider}${refreshText ? ' ‚Ä¢ ' + refreshText : ''}</div>
        `;
        authGrid.appendChild(card);
      });
    } catch (e) { console.error(e) }
  }

  function getStatusBadge(status, disabled, unavailable) {
    if (disabled) return '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 border border-red-500/30">Disabled</span>';
    if (unavailable) return '<span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">Unavail</span>';
    if (status === 'active') return '<span class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 border border-green-500/30">Active</span>';
    return '<span class="text-xs px-2 py-0.5 rounded-full bg-gray-500/20 text-gray-400 border border-gray-500/30">' + (status || 'Unknown') + '</span>';
  }

  function formatRelativeTime(timestamp) {
    if (!timestamp) return null;
    const d = new Date(timestamp); if (isNaN(d.getTime())) return null;
    const diff = (Date.now() - d.getTime()) / 1000;
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
  }

  function updateModelDropdown(imgModels) {
    // This is primarily for the usage view fallback
    const select = document.getElementById('model-select');
    if (!select) return;
    // We only update if empty or error to avoid overwriting specific load logic
    if (select.options.length <= 1) { // Just loading or select prompt
      imgModels.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        select.appendChild(opt);
      });
    }
  }

  // --- Logs Logic ---
  async function fetchLogs(initial = false) {
    const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}` };
    let url = `/v0/management/logs?key=${MANAGEMENT_KEY}&limit=200`;
    if (!initial && latestLogTimestamp > 0) { url += `&after=${latestLogTimestamp}`; }
    try {
      const res = await fetch(url, { headers });
      if (!res.ok) { document.getElementById('log-status').textContent = 'Error: ' + res.status; return; }
      const data = await res.json();
      const lines = data.lines || [];
      if (data['latest-timestamp']) latestLogTimestamp = data['latest-timestamp'];
      document.getElementById('log-status').textContent = `${data['line-count'] || 0} lines total`;
      const terminal = document.getElementById('log-terminal');
      lines.forEach(line => { const el = document.createElement('div'); el.className = getLogLineClass(line); el.textContent = line; terminal.appendChild(el); });
      if (document.getElementById('log-autoscroll').checked) { terminal.scrollTop = terminal.scrollHeight; }
    } catch (e) { document.getElementById('log-status').textContent = 'Failed'; console.error(e); }
  }
  function getLogLineClass(line) { if (line.includes('[error]') || line.includes('[fatal]')) return 'log-line-error'; if (line.includes('[warn]')) return 'log-line-warn'; if (line.includes('[debug]')) return 'log-line-debug'; return 'log-line-info'; }
  function startLogPolling() { if (logPollInterval) return; document.getElementById('log-terminal').innerHTML = ''; latestLogTimestamp = 0; fetchLogs(true); logPollInterval = setInterval(() => fetchLogs(false), 2000); }
  function stopLogPolling() { if (logPollInterval) { clearInterval(logPollInterval); logPollInterval = null; } }
  function clearLogView() { document.getElementById('log-terminal').innerHTML = ''; latestLogTimestamp = 0; fetchLogs(true); }
  async function clearLogsApi() { if (!confirm('Clear all server logs?')) return; try { await fetch(`/v0/management/logs?key=${MANAGEMENT_KEY}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } }); showToast('Logs cleared'); clearLogView(); } catch (e) { alert('Failed'); } }

  // --- Config Logic ---
  async function loadConfigTab() {
    const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}` };
    Promise.all([fetch(`/v0/management/debug?key=${MANAGEMENT_KEY}`, { headers }).then(r => r.json()), fetch(`/v0/management/usage-statistics-enabled?key=${MANAGEMENT_KEY}`, { headers }).then(r => r.json()), fetch(`/v0/management/request-log?key=${MANAGEMENT_KEY}`, { headers }).then(r => r.json())]).then(([debug, usage, reqLog]) => { document.getElementById('cfg-debug').checked = debug.debug; document.getElementById('cfg-usage').checked = usage['usage-statistics-enabled']; document.getElementById('cfg-reqlog').checked = reqLog['request-log']; });
    fetch(`/v0/management/api-keys?key=${MANAGEMENT_KEY}`, { headers }).then(r => r.json()).then(data => { const list = document.getElementById('api-keys-list'); list.innerHTML = ''; const keys = data['api-keys'] || []; if (keys.length === 0) { list.innerHTML = '<div class="text-muted text-sm text-center py-2">No client API keys set.</div>'; } else { keys.forEach((key, idx) => { const row = document.createElement('div'); row.className = 'flex items-center justify-between bg-white/5 p-3 rounded group'; row.innerHTML = `<code class="text-sm font-mono text-accent truncate max-w-[70%]">${key}</code><button onclick="deleteApiKey(${idx})" class="text-red-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition px-2">Delete</button>`; list.appendChild(row); }); } });
    fetch(`/v0/management/config/yaml?key=${MANAGEMENT_KEY}`, { headers }).then(r => r.text()).then(yaml => { document.getElementById('raw-config-editor').value = yaml; });
  }
  async function updateConfig(endpoint, value) { try { await fetch(`/v0/management/${endpoint}?key=${MANAGEMENT_KEY}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ value: value }) }); showToast('Setting updated'); fetchData(); } catch (e) { alert('Failed'); } }
  async function addApiKey() {
    // Replaced by Modal
    openAddAccountModal();
    // const key = prompt("Enter new Client API Key:"); if (!key) return; try { const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}`, 'Content-Type': 'application/json' }; const currentRes = await fetch(`/v0/management/api-keys?key=${MANAGEMENT_KEY}`, { headers }); const currentData = await currentRes.json(); const keys = currentData['api-keys'] || []; keys.push(key); await fetch(`/v0/management/api-keys?key=${MANAGEMENT_KEY}`, { method: 'PUT', headers, body: JSON.stringify(keys) }); showToast('Key added'); loadConfigTab(); } catch (e) { alert('Failed'); } 
  }

  function openAddAccountModal() {
    document.getElementById('add-account-modal').classList.remove('hidden');
    document.getElementById('auth-file-input').value = '';
    document.getElementById('auth-json-content').value = '';
    document.getElementById('auth-file-name').value = '';
  }

  function closeAddAccountModal() {
    document.getElementById('add-account-modal').classList.add('hidden');
  }

  async function addClientKey() {
    const key = prompt("Enter new Client API Key:");
    if (!key) return;
    try {
      const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}`, 'Content-Type': 'application/json' };
      const currentRes = await fetch(`/v0/management/api-keys?key=${MANAGEMENT_KEY}`, { headers });
      const currentData = await currentRes.json();
      const keys = currentData['api-keys'] || [];
      keys.push(key);
      await fetch(`/v0/management/api-keys?key=${MANAGEMENT_KEY}`, { method: 'PUT', headers, body: JSON.stringify(keys) });
      showToast('Client Key added');
      loadConfigTab();
    } catch (e) {
      alert('Failed');
    }
  }

  async function deleteAccount(filename, event) {
    event.stopPropagation(); // Prevent card click
    if (!confirm(`Are you sure you want to delete this account?\n\n${filename}`)) {
      return;
    }
    try {
      const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}` };
      const res = await fetch(`/v0/management/auth-files?name=${encodeURIComponent(filename)}&key=${MANAGEMENT_KEY}`, {
        method: 'DELETE',
        headers
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Delete failed');
      }
      showToast('Account deleted successfully');
      fetchData(); // Refresh the grid
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function importAuthFile() {
    const fileInput = document.getElementById('auth-file-input');
    const jsonContent = document.getElementById('auth-json-content').value.trim();
    const fileNameInput = document.getElementById('auth-file-name').value.trim();

    if (!fileInput.files.length && !jsonContent) {
      alert("Please select a file or paste JSON content.");
      return;
    }

    const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}` };
    const formData = new FormData();

    try {
      if (fileInput.files.length > 0) {
        // File Upload
        formData.append("file", fileInput.files[0]);
        const res = await fetch(`/v0/management/auth-files?key=${MANAGEMENT_KEY}`, {
          method: 'POST',
          headers: headers, // let browser set content-type for multipart
          body: formData
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Upload failed');
      } else {
        // Raw Content Upload
        if (!fileNameInput) {
          alert("Please provide a filename (e.g. key.json).");
          return;
        }
        if (!fileNameInput.endsWith('.json')) {
          alert("Filename must end with .json");
          return;
        }
        // Validate JSON
        try { JSON.parse(jsonContent); } catch (e) { alert("Invalid JSON content"); return; }

        const res = await fetch(`/v0/management/auth-files?name=${encodeURIComponent(fileNameInput)}&key=${MANAGEMENT_KEY}`, {
          method: 'POST',
          headers: { ...headers, 'Content-Type': 'application/json' }, // Force JSON
          body: jsonContent
        });
        if (!res.ok) throw new Error((await res.json()).error || 'Upload failed');
      }

      showToast('Account imported successfully');
      closeAddAccountModal();
      fetchData(); // Refresh grid
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }
  async function deleteApiKey(idx) { if (!confirm('Delete this API key?')) return; try { await fetch(`/v0/management/api-keys?index=${idx}&key=${MANAGEMENT_KEY}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } }); showToast('Key deleted'); loadConfigTab(); } catch (e) { alert('Failed'); } }
  async function saveRawConfig() { const yaml = document.getElementById('raw-config-editor').value; try { const res = await fetch(`/v0/management/config/yaml?key=${MANAGEMENT_KEY}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}`, 'Content-Type': 'application/yaml' }, body: yaml }); if (res.ok) { showToast('Config saved & reloaded'); setTimeout(() => location.reload(), 1000); } else { const err = await res.json(); alert('Error: ' + (err.message || err.error)); } } catch (e) { alert('Failed'); } }

  async function exportAccountsBundle() {
    window.location.href = `/v0/management/auth-files/export?key=${MANAGEMENT_KEY}`;
  }

  function exportAccount(filename, event) {
    event.stopPropagation();
    window.location.href = `/v0/management/auth-files/download?name=${encodeURIComponent(filename)}&key=${MANAGEMENT_KEY}`;
  }

  async function importAccountsBundle() {
    const fileInput = document.getElementById('auth-bundle-input');
    if (!fileInput.files.length) {
      alert("Please select a ZIP bundle file.");
      return;
    }

    const headers = { 'Authorization': `Bearer ${MANAGEMENT_KEY}` };
    const formData = new FormData();
    formData.append("bundle", fileInput.files[0]);

    try {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Importing...';
      btn.disabled = true;

      const res = await fetch(`/v0/management/auth-files/import?key=${MANAGEMENT_KEY}`, {
        method: 'POST',
        headers: headers,
        body: formData
      });
      const data = await res.json();

      btn.textContent = originalText;
      btn.disabled = false;

      if (!res.ok) throw new Error(data.error || 'Import failed');

      showToast(`Imported ${data.imported} accounts successfully`);
      if (data.errors && data.errors.length > 0) {
        console.warn('Some errors occurred during import:', data.errors);
      }
      closeAddAccountModal();
      fetchData();
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  // --- Activity Logic ---
  async function loadActivityLogs() {
    // Load Chart if not already loaded recently or force reload
    loadUsageChart();

    const tbody = document.getElementById('activity-table-body');
    if (!tbody) return;

    const modelFilter = document.getElementById('activity-model-filter').value;
    const statusFilter = document.getElementById('activity-status-filter').value;

    try {
      const res = await fetch(`/v0/management/activity?limit=50&model=${encodeURIComponent(modelFilter)}&status=${encodeURIComponent(statusFilter)}&key=${MANAGEMENT_KEY}`, { headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } });
      if (!res.ok) throw new Error("Failed to fetch logs");
      const data = await res.json();
      const logs = data.data || [];

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-muted">No activity found.</td></tr>';
        // do not return, need to populate filters potentially
      } else {
        tbody.innerHTML = '';
        logs.forEach((log, index) => {
          const tr = document.createElement('tr');
          const zebraClass = index % 2 === 0 ? 'bg-white/[0.02]' : 'bg-transparent';
          tr.className = `border-b border-white/5 ${zebraClass} hover:bg-white/10 transition-colors`;
          const date = new Date(log.timestamp).toLocaleString();
          const statusColor = log.is_failure ? 'text-red-400' : 'text-green-400';
          const status = log.is_failure ? 'Fail' : 'Success';
          const cost = log.cost_usd ? `$${log.cost_usd.toFixed(5)}` : '$0.00000';

          // Safe JSON stringify for button
          const statusBadge = (status === 'Success')
            ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/10 text-green-400 border border-green-500/20 shadow-glow hover:bg-green-500/20 transition-colors">
             <span class="w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5 animate-pulse"></span> Success
           </span>`
            : `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-500/10 text-red-400 border border-red-500/20">
             <span class="w-1.5 h-1.5 rounded-full bg-red-400 mr-1.5"></span> Failure
           </span>`;

          tr.innerHTML = `
        <td class="py-3 px-2 text-muted font-mono whitespace-nowrap">${date}</td>
        <td class="py-3 px-2 font-medium text-white">${log.model}</td>
        <td class="py-3 px-2 text-muted truncate max-w-[100px]" title="${log.source}">${log.source}</td>
        <td class="py-3 px-2 font-mono text-muted">
            <span class="text-blue-400">${log.input_tokens}</span> / <span class="text-purple-400">${log.output_tokens}</span>
        </td>
        <td class="py-3 px-2 text-green-400 font-bold">$${formatCompactNumber(log.cost_usd)}</td>
        <td class="py-3 px-2 text-muted">${log.duration_ms}ms</td>
        <td class="py-3 px-2">${statusBadge}</td>
        <td class="py-3 px-2">
            <button class="text-xs bg-white/5 hover:bg-accent text-white px-2 py-1 rounded transition-colors group" onclick='showActivityDetails(${JSON.stringify(log).replace(/'/g, "&#39;")})'>
                Details <span class="group-hover:translate-x-0.5 inline-block transition-transform">‚Üí</span>
            </button>
        </td>
      `;
          tbody.appendChild(tr);
        });
      }

      // Populate model filter if empty
      const modelSelect = document.getElementById('activity-model-filter');
      if (modelSelect && logs.length > 0) {
        const uniqueModels = [...new Set(logs.map(l => l.model))];
        uniqueModels.forEach(m => {
          if (!modelSelect.querySelector(`option[value="${m}"]`)) {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            modelSelect.appendChild(opt);
          }
        });
      }

    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="7" class="py-8 text-center text-red-400">Error: ${e.message}</td></tr>`;
    }
  }

  function exportActivityLogs() {
    const modelFilter = document.getElementById('activity-model-filter').value;
    const statusFilter = document.getElementById('activity-status-filter').value;
    const url = `/v0/management/activity/export?model=${encodeURIComponent(modelFilter)}&status=${encodeURIComponent(statusFilter)}&key=${MANAGEMENT_KEY}`;

    // Trigger download
    window.location.href = url;
  }

  function showActivityDetails(log) {
    document.getElementById('modal-meta').textContent = JSON.stringify({
      id: log.id,
      api_key: log.api_key,
      total_tokens: log.total_tokens,
      timestamp: log.timestamp
    }, null, 2);

    document.getElementById('modal-prompt').textContent = log.prompt_text || "(No prompt recorded)";

    const completionLabel = document.getElementById('modal-completion-label');
    const completionPre = document.getElementById('modal-completion');

    if (log.is_failure) {
      if (completionLabel) {
        completionLabel.textContent = "Error Response";
        completionLabel.classList.add('text-red-400');
      }
      if (completionPre) {
        completionPre.classList.add('border', 'border-red-500/50', 'bg-red-900/10');
        completionPre.textContent = log.completion_text || "(No error details recorded)";
      }
    } else {
      if (completionLabel) {
        completionLabel.textContent = "Response";
        completionLabel.classList.remove('text-red-400');
      }
      if (completionPre) {
        completionPre.classList.remove('border', 'border-red-500/50', 'bg-red-900/10');
        completionPre.textContent = log.completion_text || "(No completion recorded)";
      }
    }

    // Setup Replay Button
    const replayBtn = document.getElementById('modal-replay-btn');
    if (replayBtn) {
      // Store log in a way the handler can access, or just update the onclick handler here
      // We can pass the log object directly if we assign the function here
      replayBtn.onclick = () => replayLog(log);
    }

    document.getElementById('activity-modal').classList.remove('hidden');
  }

  function replayLog(log) {
    // 1. Close modal
    closeActivityModal();

    // 2. Switch to Playground
    switchTab('playground');

    // 3. Populate Inputs
    const promptText = log.prompt_text || "";
    let finalPrompt = promptText;

    // Attempt to parse JSON messages if stored that way (e.g. [{"role":"user",...}])
    try {
      if (promptText.trim().startsWith('[')) {
        const messages = JSON.parse(promptText);
        const lastUserMsg = messages.reverse().find(m => m.role === 'user');
        if (lastUserMsg) finalPrompt = lastUserMsg.content;
      }
    } catch (e) {
      // Not JSON, use raw text
    }

    const inputEl = document.getElementById('chat-input');
    if (inputEl) {
      inputEl.value = finalPrompt;
      // Trigger resize if needed, or visual update
    }

    // 4. Select Model
    const modelSelect = document.getElementById('model-select');
    if (modelSelect && log.model) {
      // Check if option exists, if not add it temp?
      if (!modelSelect.querySelector(`option[value="${log.model}"]`)) {
        const opt = document.createElement('option');
        opt.value = log.model;
        opt.textContent = log.model + " (History)";
        modelSelect.appendChild(opt);
      }
      modelSelect.value = log.model;
      localStorage.setItem('selected_model', log.model);
    }
  }

  function closeActivityModal() {
    document.getElementById('activity-modal').classList.add('hidden');
  }

  let usageChartInstance = null;
  async function loadUsageChart() {
    const ctx = document.getElementById('usage-chart');
    if (!ctx) return;

    try {
      const res = await fetch(`/v0/management/stats/trends?limit=24&group_by=hour&key=${MANAGEMENT_KEY}`, { headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } });
      if (!res.ok) return; // endpoint might not be ready
      const json = await res.json();
      const data = json.data || [];

      // Calculate Total Cost from trends
      let totalCost = 0;
      data.forEach(d => totalCost += (d.cost || 0));
      const costEl = document.getElementById('total-cost');
      if (costEl) costEl.textContent = `$${totalCost.toFixed(4)}`;

      // data is ordered new->old from API, we reversed it in backend?  
      // wait, backend code: "Reverse result to be chronological". Perfect.

      const labels = data.map(d => {
        let date;
        // Check if bucket is a numeric timestamp (seconds) or string number
        if (!isNaN(d.bucket) && !d.bucket.toString().includes('-')) {
          date = new Date(d.bucket * 1000);
        } else {
          // Assume formatted string like "YYYY-MM-DD HH:00" from SQLite
          // Replace space with T and add Z to treat as UTC (backend stores/returns UTC)
          const isoString = d.bucket.replace(' ', 'T') + ':00Z';
          date = new Date(isoString);
        }
        return date.getHours() + ':00';
      });
      const requests = data.map(d => d.requests);
      const failures = data.map(d => d.failures);

      document.getElementById('chart-skeleton').classList.add('hidden');
      document.getElementById('usage-chart').classList.remove('opacity-0');

      if (usageChartInstance) usageChartInstance.destroy();

      const dataPoints = requests; // Assuming 'requests' is the primary data for the new chart

      const ctx2d = document.getElementById('usage-chart').getContext('2d');

      // Gradient Fill
      const gradient = ctx2d.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(0, 117, 255, 0.5)');   // Brand Blue
      gradient.addColorStop(1, 'rgba(0, 117, 255, 0.0)');   // Transparent

      window.usageChart = new Chart(ctx2d, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Requests',
            data: dataPoints,
            borderColor: '#0075FF',
            backgroundColor: gradient,
            borderWidth: 2,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#0075FF',
            pointRadius: 4,
            pointHoverRadius: 6,
            fill: true,
            tension: 0.4 // Smooth curves
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#fff',
              bodyColor: '#cbd5e1',
              padding: 10,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function (context) {
                  return context.parsed.y + ' requests';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.05)', borderDash: [5, 5] },
              ticks: { color: '#6B7280', font: { family: "'Plus Jakarta Display', sans-serif" } }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#6B7280', font: { family: "'Plus Jakarta Display', sans-serif" } }
            }
          }
        }
      });

      // Draw Sparklines (Recycle the same request data for liveliness)
      drawSparkline('sparkline-requests', dataPoints, '#0075FF');
      drawSparkline('sparkline-tokens', dataPoints, '#A855F7'); // Purple for tokens

    } catch (e) {
      console.error("Failed to load chart", e);
    }
  }

  function drawSparkline(canvasId, data, color) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    // Destroy existing if any? Chart.js usually needs instance tracking but for sparklines we might just overwrite canvas or verify API
    // Simple Chart.js instance management:
    if (ctx.chart) ctx.chart.destroy();

    ctx.chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map((_, i) => i), // dummy labels
        datasets: [{
          data: data,
          borderColor: color,
          borderWidth: 2,
          fill: false,
          pointRadius: 0, // No points
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          x: { display: false },
          y: { display: false, min: 0 } // ensure baseline is consistent
        },
        layout: { padding: 0 }
      }
    });
  }

  // Donation Logic
  function openDonationModal() {
    document.getElementById('donation-modal').classList.remove('hidden');
  }

  function closeDonationModal() {
    document.getElementById('donation-modal').classList.add('hidden');
  }

  function switchDonationTab(tab) {
    if (tab === 'vn') {
      document.getElementById('donation-content-vn').classList.remove('hidden');
      document.getElementById('donation-content-global').classList.add('hidden');
      document.getElementById('tab-btn-vn').className = "flex-1 pb-2 text-sm font-bold text-yellow-400 border-b-2 border-yellow-400 transition-colors";
      document.getElementById('tab-btn-global').className = "flex-1 pb-2 text-sm font-bold text-muted hover:text-white border-b-2 border-transparent transition-colors";
    } else {
      document.getElementById('donation-content-vn').classList.add('hidden');
      document.getElementById('donation-content-global').classList.remove('hidden');
      document.getElementById('tab-btn-vn').className = "flex-1 pb-2 text-sm font-bold text-muted hover:text-white border-b-2 border-transparent transition-colors";
      document.getElementById('tab-btn-global').className = "flex-1 pb-2 text-sm font-bold text-yellow-400 border-b-2 border-yellow-400 transition-colors";
    }
  }

  function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('Copied to clipboard!');
    });
  }

  function copyInput(id) {
    const input = document.getElementById(id);
    input.select();
    navigator.clipboard.writeText(input.value).then(() => {
      showToast('Address copied!');
    });
  }

  // --- Chat Logic ---
  let currentAttachment = null;
  const chatHistory = [];

  async function loadModels() {
    const select = document.getElementById('model-select');
    try {
      // Use the management registry endpoint (doesn't require client API auth)
      const res = await fetch(`/v0/management/registry/models?key=${MANAGEMENT_KEY}`, { headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } });
      if (!res.ok) throw new Error('Failed to fetch models');

      const data = await res.json();
      const models = (data.models || []).map(m => m.id).filter(Boolean);

      select.innerHTML = '<option value="" disabled selected>Select Model</option>';
      // Sort models
      models.sort((a, b) => a.localeCompare(b)).forEach(modelId => {
        const opt = document.createElement('option');
        opt.value = modelId;
        opt.textContent = modelId;
        select.appendChild(opt);
      });

      // Restore selection
      const savedModel = localStorage.getItem('selected_model');
      if (savedModel && models.includes(savedModel)) {
        select.value = savedModel;
      }

    } catch (e) {
      console.error('loadModels error:', e);
      // Fallback
      select.innerHTML = '<option value="" disabled>Error loading models</option><option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option><option value="gpt-4o">gpt-4o</option><option value="claude-3-5-sonnet">claude-3-5-sonnet</option>';
    }

    select.addEventListener('change', (e) => localStorage.setItem('selected_model', e.target.value));
  }

  // Call loadModels when switching to playground



  function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      currentAttachment = e.target.result; // Data URL
      showImagePreview(currentAttachment);
    };
    reader.readAsDataURL(file);
    input.value = ''; // Reset
  }

  function showImagePreview(src) {
    const container = document.getElementById('image-preview-container');
    container.innerHTML = `
        <div class="relative group w-16 h-16 rounded overflow-hidden border border-white/10 shrink-0 mb-2">
          <img src="${src}" class="w-full h-full object-cover">
          <button onclick="removeAttachment()" class="absolute top-0 right-0 bg-black/50 hover:bg-red-500/80 text-white p-0.5 rounded-bl">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg>
          </button>
        </div>
      `;
    container.classList.remove('hidden');
  }

  function removeAttachment() {
    currentAttachment = null;
    document.getElementById('image-preview-container').innerHTML = '';
    document.getElementById('image-preview-container').classList.add('hidden');
  }

  function renderChat() {
    const container = document.getElementById('chat-messages');
    if (chatHistory.length === 0) {
      container.innerHTML = `
          <div class="text-center text-muted text-sm py-20 flex flex-col items-center opacity-50">
            <div class="text-4xl mb-4">üí¨</div>
            <div>Select a model to start chatting</div>
          </div>`;
      return;
    }
    container.innerHTML = '';

    chatHistory.forEach(msg => {
      const isUser = msg.role === 'user';
      const wrapper = document.createElement('div');
      wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

      const bubble = document.createElement('div');
      bubble.className = `max-w-[85%] rounded-2xl px-5 py-3 text-sm leading-relaxed shadow-sm ${isUser ? 'bg-accent text-white rounded-br-none' : 'bg-card border border-white/10 rounded-bl-none text-gray-200'}`;

      // Content rendering
      let contentHtml = '';
      const showThinking = document.getElementById('show-thinking-toggle')?.checked ?? true;

      if (msg.role === 'assistant' && msg.reasoning_content && showThinking) {
        contentHtml += `<details class="mb-4 bg-black/20 rounded-lg overflow-hidden border border-white/5">
             <summary class="px-3 py-2 text-xs font-mono text-muted cursor-pointer hover:bg-white/5 select-none flex items-center">
               <span class="mr-2">üí≠</span> Thinking Process
             </summary>
             <div class="px-3 py-2 text-xs text-gray-400 font-mono border-t border-white/5 whitespace-pre-wrap">${escapeHtml(msg.reasoning_content)}</div>
           </details>`;
      }

      if (Array.isArray(msg.content)) {
        msg.content.forEach(part => {
          if (part.type === 'text') contentHtml += marked.parse(part.text);
          if (part.type === 'image_url') contentHtml += `<img src="${part.image_url.url}" class="max-w-full rounded-lg mb-2 border border-white/10">`;
        });
      } else {
        contentHtml += marked.parse(msg.content || '');
      }

      bubble.innerHTML = contentHtml; // Warning: naive HTML insertion, but acceptable for internal tool
      wrapper.appendChild(bubble);
      container.appendChild(wrapper);
    });

    function escapeHtml(text) {
      if (!text) return text;
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    container.scrollTop = container.scrollHeight;
  }

  function clearChat() {
    chatHistory.length = 0;
    renderChat();
    removeAttachment();
  }

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const model = document.getElementById('model-select').value;
    const text = input.value.trim();
    const systemPrompt = document.getElementById('system-prompt').value.trim();

    if ((!text && !currentAttachment) || !model) {
      if (!model) alert('Please select a model first');
      return;
    }

    // Construct User Message
    let userMsgContent;
    if (currentAttachment) {
      userMsgContent = [
        { type: 'text', text: text },
        { type: 'image_url', image_url: { url: currentAttachment } }
      ];
    } else {
      userMsgContent = text;
    }

    // Add to history
    chatHistory.push({ role: 'user', content: userMsgContent });
    renderChat();

    input.value = '';
    removeAttachment();

    // Add Assistant Placeholder
    const placeholderIndex = chatHistory.push({ role: 'assistant', content: '...' }) - 1;
    renderChat();

    const indicator = document.getElementById('typing-indicator');
    const sendBtn = document.getElementById('send-btn');

    indicator.classList.remove('hidden');
    sendBtn.disabled = true;

    try {
      let API_KEY = localStorage.getItem('playground_api_key') || 'sk-antigravity-client-key';

      const messagesToSend = [...chatHistory.slice(0, placeholderIndex)];

      // Prepend system prompt if exists
      if (systemPrompt) {
        messagesToSend.unshift({ role: 'system', content: systemPrompt });
      }

      // Read new parameters
      const temp = parseFloat(document.getElementById('temp-input').value);
      const maxTokens = parseInt(document.getElementById('maxtokens-input').value);
      const topP = parseFloat(document.getElementById('topp-input').value);

      const payload = {
        model: model,
        messages: messagesToSend,
        temperature: temp,
        max_tokens: maxTokens,
        top_p: topP
      };

      const response = await fetch('/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify(payload)
      });

      if (response.status === 401) {
        const newKey = prompt("Enter a valid Proxy API Key:", API_KEY);
        if (newKey) {
          localStorage.setItem('playground_api_key', newKey);
          // Remove placeholder and last user msg to retry properly (or just recurse)
          // Simple retry:
          chatHistory.pop(); // remove placeholder
          chatHistory.pop(); // remove user msg (it will be re-added by recursive call logic if we weren't careful) 
          // Actually re-calling sendMessage would duplicate history pushing. 
          // Let's just alert and let user click send again.
          alert("Key updated. Please click Send again.");
          // Restore input
          if (typeof userMsgContent === 'string') input.value = userMsgContent;
          else input.value = userMsgContent.find(p => p.type === 'text')?.text || '';
          // If attach was used, we lost it in UI but it's in history... complicate.
          // Let's just reload.
          return;
        }
        throw new Error("Unauthorized");
      }

      const data = await response.json();
      const choices = data.choices?.[0];
      const reply = choices?.message?.content || "Error: No response.";
      const reasoning = choices?.message?.reasoning_content || choices?.reasoning_content; // Handle flat or message-nested reasoning

      chatHistory[placeholderIndex].content = reply;
      if (reasoning) {
        chatHistory[placeholderIndex].reasoning_content = reasoning;
      }
      renderChat();

    } catch (e) {
      chatHistory[placeholderIndex].content = `Error: ${e.message}`;
      renderChat();
    } finally {
      indicator.classList.add('hidden');
      sendBtn.disabled = false;
    }
  }

  const tx = document.getElementById('chat-input');

  function adjustHeight() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + "px";
    this.style.overflowY = 'hidden';
  }

  tx.addEventListener("input", adjustHeight, false);

  // Initial adjustment after a short delay to ensure rendering
  requestAnimationFrame(() => adjustHeight.call(tx));
  tx.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Utils
  function formatNumber(num) { if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'; if (num >= 1000) return (num / 1000).toFixed(1) + 'k'; return num.toString(); }
  function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg; t.style.opacity = '1'; t.style.transform = 'translateY(0)'; setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(80px)'; }, 3000); }
  async function startAuth(provider) { if (provider === 'vertex') { alert('Vertex requires manual service account JSON upload.'); return; } try { const res = await fetch(`/v0/management/${provider}-auth-url?is_webui=true&key=${MANAGEMENT_KEY}`, { headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } }); const data = await res.json(); if (data.url) { window.open(data.url, '_blank', 'width=600,height=700'); showToast(`Opened ${provider} login window`); } else { alert('Could not get auth URL.'); } } catch (e) { alert('Failed.'); } }

  // Welcome Message based on time
  function updateWelcomeMessage() {
    const hour = new Date().getHours();
    let greeting = 'üëã Welcome back!';
    if (hour < 12) greeting = '‚òÄÔ∏è Good morning!';
    else if (hour < 18) greeting = 'üå§Ô∏è Good afternoon!';
    else greeting = 'üåô Good evening!';
    const el = document.getElementById('welcome-message');
    if (el) el.textContent = greeting;
  }

  // Footer Stats
  const pageLoadTime = Date.now();
  function updateFooterStats() {
    // Uptime
    const uptime = Math.floor((Date.now() - pageLoadTime) / 1000);
    const mins = Math.floor(uptime / 60);
    const secs = uptime % 60;
    const uptimeEl = document.getElementById('footer-uptime');
    if (uptimeEl) uptimeEl.textContent = `${mins}m ${secs}s`;

    // Last Sync
    const syncEl = document.getElementById('footer-last-sync');
    if (syncEl) syncEl.textContent = new Date().toLocaleTimeString();
  }
  setInterval(updateFooterStats, 1000);

  updateWelcomeMessage();
  checkAuth(); fetchData(); setInterval(fetchData, 5000);
  // --- Advanced Keys Logic ---
  async function loadManagedKeys() {
    const listBody = document.getElementById('keys-table-body');
    listBody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-muted">Loading keys...</td></tr>';

    try {
      const res = await fetch(`/v0/management/advanced-keys?key=${MANAGEMENT_KEY}`, { headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } });
      if (!res.ok) throw new Error("Failed to load keys");
      const data = await res.json();
      const keys = data.keys || [];

      if (keys.length === 0) {
        listBody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-muted">No managed keys found. Create one to get started.</td></tr>';
        return;
      }

      listBody.innerHTML = '';
      keys.forEach(key => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-white/5 hover:bg-white/5 transition-colors group';

        const quotaUSD = key.quota_limit_usd > 0 ? `$${key.quota_limit_usd.toFixed(2)}` : 'Unlimited';
        const quotaReq = key.quota_limit_requests > 0 ? `${key.quota_limit_requests} reqs` : 'Unlimited';
        const rateLimit = key.rate_limit_rpm > 0 ? `${key.rate_limit_rpm} RPM` : 'Unlimited';

        const statusBadge = key.is_active
          ? '<span class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 border border-green-500/30">Active</span>'
          : '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 border border-red-500/30">Inactive</span>';

        let expiry = 'Never';
        if (key.expires_at && key.expires_at !== "0001-01-01T00:00:00Z") {
          const expDate = new Date(key.expires_at);
          expiry = expDate.toLocaleDateString();
          if (expDate < new Date()) {
            // statusBadge = '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 border border-red-500/30">Expired</span>';
          }
        }

        tr.innerHTML = `
          <td class="py-3 px-4 font-medium text-white">${key.label}</td>
          <td class="py-3 px-4 font-mono text-muted text-xs">${key.key_prefix}...</td>
          <td class="py-3 px-4 text-muted text-xs">
            <div>${quotaUSD}</div>
            <div class="opacity-50 text-[10px]">${quotaReq}</div>
          </td>
          <td class="py-3 px-4 text-muted text-xs">${rateLimit}</td>
          <td class="py-3 px-4">
             <div class="flex flex-col gap-1">
               ${statusBadge}
               <span class="text-[10px] text-muted opacity-60">Exp: ${expiry}</span>
             </div>
          </td>
          <td class="py-3 px-4 text-right">
            <button onclick="deleteManagedKey('${key.key_hash}')" class="text-xs text-red-400 hover:text-red-300 hover:bg-red-500/20 px-2 py-1.5 rounded transition">Revoke</button>
          </td>
        `;
        listBody.appendChild(tr);
      });
    } catch (e) {
      listBody.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-red-400">Error: ${e.message}</td></tr>`;
    }
  }

  function openCreateKeyModal() {
    document.getElementById('create-key-modal').classList.remove('hidden');
    fetchAvailableModelsForSelector();
  }

  function closeCreateKeyModal() {
    document.getElementById('create-key-modal').classList.add('hidden');
    document.getElementById('create-key-form').reset();
  }

  async function fetchAvailableModelsForSelector() {
    const container = document.getElementById('create-key-model-selector');
    try {
      const res = await fetch(`/v0/management/registry/models?key=${MANAGEMENT_KEY}`, { headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` } });
      const data = await res.json();
      // The endpoint returns { "models": [ {id: "name", ...}, ... ] }
      // We map to just IDs for the check list
      const fetchedModels = (data.models || []).map(m => m.id);

      const standardModels = []; // No longer hardcoding defaults, rely on registry
      const allModels = [...new Set([...standardModels, ...fetchedModels])].sort();

      container.innerHTML = '';
      if (allModels.length === 0) {
        container.innerHTML = '<div class="text-sm text-muted">No models found in registry.</div>';
        return;
      }

      allModels.forEach(model => {
        const div = document.createElement('div');
        div.className = 'flex items-center hover:bg-white/5 p-1 rounded';
        div.innerHTML = `
          <input type="checkbox" name="allowed_models" value="${model}" id="model-${model}" class="mr-2 accent-accent cursor-pointer">
          <label for="model-${model}" class="text-xs">${model}</label>
        `;
        container.appendChild(div);
      });

    } catch (e) {
      container.innerHTML = `<div class="text-red-400 text-xs">Failed to load models: ${e.message}</div>`;
    }
  }

  function selectAllModels(selected) {
    const checkboxes = document.querySelector('#create-key-model-selector').querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = selected);
  }

  function selectModelsByProvider(keyword) {
    const checkboxes = document.querySelector('#create-key-model-selector').querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
      if (cb.value.toLowerCase().includes(keyword.toLowerCase())) {
        cb.checked = true;
      } else {
        cb.checked = false;
      }
    });
  }

  async function handleCreateKey(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const label = formData.get('label');
    const quotaUSD = parseFloat(formData.get('quota_limit_usd')) || 0;
    const rateLimit = parseInt(formData.get('rate_limit_rpm')) || 0;
    const reqLimit = parseInt(formData.get('quota_limit_requests')) || 0;
    const expiresAt = formData.get('expires_at') ? new Date(formData.get('expires_at')).toISOString() : null;

    const checkedModels = [];
    e.target.querySelectorAll('input[name="allowed_models"]:checked').forEach(cb => checkedModels.push(cb.value));

    // Calculate expires_in_seconds from expires_at logic
    let expiresInSeconds = 0;
    if (expiresAt) {
      const diff = new Date(expiresAt).getTime() - Date.now();
      if (diff > 0) expiresInSeconds = Math.floor(diff / 1000);
    }

    const payload = {
      label: label,
      quota_limit_usd: quotaUSD,
      quota_limit_requests: reqLimit,
      rate_limit_rpm: rateLimit,
      allowed_models: checkedModels,
      expires_in_seconds: expiresInSeconds
    };

    try {
      const btn = e.target.querySelector('button[type="submit"]');
      const oldText = btn.textContent;
      btn.textContent = "Creating...";
      btn.disabled = true;

      const res = await fetch(`/v0/management/advanced-keys?key=${MANAGEMENT_KEY}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error((await res.json()).error || 'Failed to create key');

      const data = await res.json();
      console.log('Key Creation Response:', data); // Debug log


      closeCreateKeyModal();
      document.getElementById('new-key-value').value = data.api_key;
      document.getElementById('new-key-display-modal').classList.remove('hidden');

      loadManagedKeys();

      btn.textContent = oldText;
      btn.disabled = false;
    } catch (err) {
      alert("Error: " + err.message);
      e.target.querySelector('button[type="submit"]').disabled = false;
      e.target.querySelector('button[type="submit"]').textContent = "Create Key";
    }
  }

  async function deleteManagedKey(hash) {
    if (!confirm("Are you sure you want to revoke this API key? This action cannot be undone.")) return;
    try {
      const res = await fetch(`/v0/management/advanced-keys/${hash}?key=${MANAGEMENT_KEY}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${MANAGEMENT_KEY}` }
      });
      if (!res.ok) throw new Error("Failed to delete key");
      showToast("Key revoked successfully");
      loadManagedKeys();
    } catch (e) {
      alert("Error: " + e.message);
    }
  }

  function copyNewKey() {
    const el = document.getElementById('new-key-value');
    el.select();
    document.execCommand('copy');
    showToast("Key copied to clipboard");
  }

  function closeNewKeyModal() {
    document.getElementById('new-key-display-modal').classList.add('hidden');
  }

  const originalSwitchTab = switchTab;
  switchTab = function (tabId) {
    originalSwitchTab(tabId);
    if (tabId === 'advanced-keys') {
      loadManagedKeys();
    }
  };
</script>
</body>

</html>